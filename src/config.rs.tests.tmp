#[cfg(test)]
mod tests {
    use super::*;
    use std::env;
    use tempfile::TempDir;

    // Helper function to create a temporary config directory
    fn setup_test_config_dir() -> (TempDir, PathBuf) {
        let temp_dir = TempDir::new().expect("Failed to create temp dir");
        let config_dir = temp_dir.path().join("reposentry");
        std::fs::create_dir_all(&config_dir).expect("Failed to create config dir");
        (temp_dir, config_dir)
    }

    #[test]
    fn test_config_default_values() {
        let config = Config::default();

        assert_eq!(config.base_directory, "${HOME}/dev");
        assert!(config.github.include_organizations);
        assert!(!config.github.include_forks);
        assert_eq!(config.sync.max_parallel, 4);
        assert_eq!(config.sync.timeout, 300);
        assert!(!config.sync.auto_stash);
        assert!(config.sync.fast_forward_only);
        assert!(!config.daemon.enabled);
        assert!(config.organization.separate_org_dirs);
        assert!(config.advanced.preserve_timestamps);
    }

    #[test]
    fn test_age_filter_to_duration() {
        let one_month = AgeFilter { max_age: Some("1month".to_string()) };
        let three_months = AgeFilter { max_age: Some("3month".to_string()) };
        let six_months = AgeFilter { max_age: Some("6month".to_string()) };
        let invalid = AgeFilter { max_age: Some("invalid".to_string()) };
        let none_filter = AgeFilter { max_age: None };

        assert_eq!(one_month.to_duration().unwrap().num_days(), 30);
        assert_eq!(three_months.to_duration().unwrap().num_days(), 90);
        assert_eq!(six_months.to_duration().unwrap().num_days(), 180);
        assert!(invalid.to_duration().is_err());
        assert!(none_filter.to_duration().is_none());
    }

    #[test]
    fn test_size_filter_to_bytes() {
        let hundred_mb = SizeFilter { max_size: Some("100MB".to_string()) };
        let one_gb = SizeFilter { max_size: Some("1GB".to_string()) };
        let invalid = SizeFilter { max_size: Some("invalid".to_string()) };
        let none_filter = SizeFilter { max_size: None };

        assert_eq!(hundred_mb.to_bytes().unwrap(), Some(100 * 1024 * 1024));
        assert_eq!(one_gb.to_bytes().unwrap(), Some(1024 * 1024 * 1024));
        assert!(invalid.to_bytes().is_err());
        assert_eq!(none_filter.to_bytes().unwrap(), None);
    }

    #[test]
    fn test_expand_env_vars() {
        // Set up test environment
        env::set_var("TEST_HOME", "/test/home");

        let mut config = Config::default();
        config.base_directory = "${TEST_HOME}/dev".to_string();

        config.expand_env_vars().expect("Failed to expand env vars");

        assert_eq!(config.base_directory, "/test/home/dev");

        // Clean up
        env::remove_var("TEST_HOME");
    }

    #[test]
    fn test_expand_env_vars_missing() {
        let mut config = Config::default();
        config.base_directory = "${NONEXISTENT_VAR}/dev".to_string();

        let result = config.expand_env_vars();
        assert!(result.is_err());
        assert!(result.unwrap_err().to_string().contains("NONEXISTENT_VAR"));
    }

    #[test]
    fn test_config_load_nonexistent_file() {
        let nonexistent_path = Path::new("/nonexistent/config.yml");
        let result = Config::load_from(nonexistent_path);
        assert!(result.is_err());
    }

    #[test]
    fn test_config_save_and_load() {
        let (_temp_dir, config_dir) = setup_test_config_dir();
        let config_path = config_dir.join("config.yml");

        // Create a config with non-default values
        let mut config = Config::default();
        config.base_directory = "/custom/path".to_string();
        config.github.username = Some("testuser".to_string());
        config.filters.age.max_age = Some("1month".to_string());
        config.sync.max_parallel = 8;

        // Save the config
        config.save_to(&config_path).expect("Failed to save config");

        // Load it back
        let loaded_config = Config::load_from(&config_path).expect("Failed to load config");

        assert_eq!(loaded_config.base_directory, "/custom/path");
        assert_eq!(loaded_config.github.username, Some("testuser".to_string()));
        assert_eq!(loaded_config.filters.age.max_age, Some("1month".to_string()));
        assert_eq!(loaded_config.sync.max_parallel, 8);
    }

    #[test]
    fn test_config_default_path_xdg() {
        // This test verifies that the default path respects XDG directories
        let default_path = Config::default_path();
        assert!(default_path.to_string_lossy().contains("reposentry"));
        assert!(default_path.to_string_lossy().ends_with("config.yml"));
    }

    #[test]
    fn test_filtering_methods() {
        let mut config = Config::default();
        config.filters.age.max_age = Some("3month".to_string());
        config.filters.size.max_size = Some("1GB".to_string());

        // Test age filtering
        assert_eq!(config.age_filter_days().unwrap(), Some(90));

        // Test size filtering
        assert_eq!(config.size_filter_bytes().unwrap(), Some(1024 * 1024 * 1024));

        // Test actual filtering methods
        let old_timestamp = chrono::Utc::now() - chrono::Duration::days(100);
        let recent_timestamp = chrono::Utc::now() - chrono::Duration::days(30);

        assert!(config.should_filter_by_age(old_timestamp));
        assert!(!config.should_filter_by_age(recent_timestamp));

        // Test size filtering
        let large_size = 2 * 1024 * 1024 * 1024; // 2GB
        let small_size = 500 * 1024 * 1024; // 500MB

        assert!(config.should_filter_by_size(large_size));
        assert!(!config.should_filter_by_size(small_size));
    }

    #[test]
    fn test_yaml_parsing() {
        let yaml_content = r#"
base_directory: "${HOME}/custom-dev"
filters:
  age:
    max_age: "1month"
  size:
    max_size: "500MB"
github:
  auth_method: "gh_cli"
  username: "testuser"
  include_organizations: false
  include_forks: true
sync:
  max_parallel: 8
  timeout: 600
  auto_stash: true
  fast_forward_only: false
daemon:
  enabled: true
  interval: "1h"
logging:
  level: "debug"
  format: "json"
  color: false
organization:
  separate_org_dirs: false
advanced:
  preserve_timestamps: false
"#;

        let config: Config = serde_yaml::from_str(yaml_content).expect("Failed to parse YAML");

        assert_eq!(config.base_directory, "${HOME}/custom-dev");
        assert_eq!(config.filters.age.max_age, Some("1month".to_string()));
        assert_eq!(config.filters.size.max_size, Some("500MB".to_string()));
        assert_eq!(config.github.username, Some("testuser".to_string()));
        assert!(!config.github.include_organizations);
        assert!(config.github.include_forks);
        assert_eq!(config.sync.max_parallel, 8);
        assert_eq!(config.sync.timeout, 600);
        assert!(config.sync.auto_stash);
        assert!(!config.sync.fast_forward_only);
        assert!(config.daemon.enabled);
        assert_eq!(config.daemon.interval, "1h");
        assert!(!config.logging.color);
        assert!(!config.organization.separate_org_dirs);
        assert!(!config.advanced.preserve_timestamps);
    }
}